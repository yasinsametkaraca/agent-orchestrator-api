FROM python:3.12-slim AS base

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=off \
    PIP_DISABLE_PIP_VERSION_CHECK=on \
    UV_SYSTEM_PYTHON=1

RUN python -m pip install --no-cache-dir --upgrade pip uv && \
    uv --version && \
    python --version

WORKDIR /app

COPY pyproject.toml README.md ./

RUN uv sync --no-dev

COPY app ./app

# Create a non-root user for running the worker
RUN useradd --create-home --shell /bin/bash appuser && \
    chown -R appuser /app

USER appuser

ENV PATH="/app/.venv/bin:$PATH"

CMD ["uv", "run", "celery", "-A", "app.worker.celery_app.celery_app", "worker", "-Q", "agent_tasks", "--loglevel=INFO"]
